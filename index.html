<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Carte Freebord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body { height:100%; margin:0; }
    #map { height:100vh; width:100%; }
    /* style pour l'icÃ´ne emoji circulaire */
    .emoji-icon { 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      color:white; 
      font-size:18px; 
      width:32px; 
      height:32px; 
      border-radius:50%; 
      border:2px solid #fff; 
      box-shadow:0 1px 2px rgba(0,0,0,0.35); 
    }
    /* filtre bouton / panneau (en haut Ã  droite) */
    #control-container { position:absolute; top:10px; right:10px; z-index:1000; text-align:right; }
    #filters { display:none; margin-top:6px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.25); text-align:left; min-width:200px;}
    .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:8% auto; padding:16px; border-radius:8px; width:92%; max-width:420px; }
    .close { float:right; font-size:20px; cursor:pointer; }
    label { font-size:14px; }
    input[type=text], input[type=url], select, input[type=number] { width:100%; padding:6px; margin:6px 0 10px 0; box-sizing:border-box; }
    button { padding:6px 10px; cursor:pointer; }
    .submit-btn { background:#007bff; color:white; border:none; border-radius:4px; margin-top:8px; }
    .submit-btn:hover { background:#0056b3; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ContrÃ´les -->
  <div id="control-container">
    <button id="filter-button">Filtre</button>
    <button id="add-button">Ajouter un spot</button>
    <div id="filters">
      <label>Pays:
        <select id="filterCountry"><option value="">Tous</option></select>
      </label><br>
      <label>Canton / RÃ©gion:
        <select id="filterRegion"><option value="">Tous</option></select>
      </label><br>
      <label>Ville:
        <select id="filterCity"><option value="">Toutes</option></select>
      </label><br>
      <label>DifficultÃ©:
        <select id="filterDifficulty">
          <option value="">Toutes</option>
          <option value="facile">Facile (Bleu)</option>
          <option value="moyen">Moyen (Rouge)</option>
          <option value="difficile">Difficile (Noir)</option>
        </select>
      </label><br>
      <button id="apply-filters">Appliquer</button>
    </div>
  </div>

  <!-- Modal Ajouter un spot -->
  <div id="addSpotModal" class="modal">
    <div class="modal-content">
      <span class="close" id="modalClose">&times;</span>
      <h3>Ajouter un spot</h3>
      <form id="spotForm" action="https://formspree.io/f/yourID" method="POST">
        <label>Nom du spot</label>
        <input type="text" name="nom" required>

        <label>TracÃ© GPS (coordonnÃ©es ou lien)</label>
        <input type="text" name="trace" required>

        <label>Pays</label>
        <input type="text" name="pays" required>

        <label>Canton / RÃ©gion</label>
        <input type="text" name="region" required>

        <label>Ville</label>
        <input type="text" name="ville" required>

        <label>DifficultÃ©</label>
        <select name="difficulte" required>
          <option value="facile">Facile (Bleu)</option>
          <option value="moyen">Moyen (Rouge)</option>
          <option value="difficile">Difficile (Noir)</option>
        </select>

        <label>VidÃ©o YouTube (URL)</label>
        <input type="url" name="video">

        <label>Lien Google Maps (dÃ©part)</label>
        <input type="url" name="maps">

        <label>QualitÃ© du bitume</label>
        <select name="bitume" required>
          <option value="1">â­</option>
          <option value="2">â­â­</option>
          <option value="3">â­â­â­</option>
          <option value="4">â­â­â­â­</option>
          <option value="5">â­â­â­â­â­</option>
        </select>

        <label>Trafic</label>
        <select name="trafic" required>
          <option value="0">â€”</option>
          <option value="1">ğŸš—</option>
          <option value="2">ğŸš—ğŸš—</option>
          <option value="3">ğŸš—ğŸš—ğŸš—</option>
          <option value="4">ğŸš—ğŸš—ğŸš—ğŸš—</option>
          <option value="5">ğŸš—ğŸš—ğŸš—ğŸš—ğŸš—</option>
        </select>

        <button type="submit" class="submit-btn">Envoyer</button>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const colorMap = {
      facile: '#1E90FF',   // bleu
      moyen:  '#FF0000',   // rouge
      difficile: '#000000' // noir
    };
    const emojiMap = {
      facile: 'ğŸ”µ',
      moyen:  'ğŸ”´',
      difficile: 'âš«'
    };

    const map = L.map('map').setView([46.52, 6.63], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // Position utilisateur
    let userMarker = null;
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(function(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        if(!userMarker) {
          userMarker = L.circleMarker([lat, lon], { radius:6, color:'#2ecc71', fillColor:'#2ecc71', fillOpacity:0.9 }).addTo(map).bindPopup('Vous Ãªtes ici');
        } else {
          userMarker.setLatLng([lat, lon]);
        }
      });
    }

    // Exemple de spot
    const spots = [
      {
        nom: "Les Bains",
        difficulte: "moyen",
        bitume: 4,
        trafic: 3,
        video: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
        lien: "https://maps.app.goo.gl/bXnBMYr7HbhJfJEc8",
        pays: "Suisse",
        canton: "VD",
        ville: "Lausanne",
        coords: [[46.51395,6.61827],[46.5139,6.61824],[46.51385,6.61822],[46.51332,6.61796]]
      }
    ];

    const registry = [];

    function createEmojiIcon(color, emoji) {
      const html = `<div class="emoji-icon" style="background:${color}">${emoji}</div>`;
      return L.divIcon({
        html,
        className: '',
        iconSize: [32,32],
        iconAnchor: [16,16]
      });
    }

    function renderSpots() {
      registry.forEach(r => {
        if (r.marker) map.removeLayer(r.marker);
        if (r.polyline && map.hasLayer(r.polyline)) map.removeLayer(r.polyline);
      });
      registry.length = 0;

      spots.forEach(s => {
        const color = colorMap[s.difficulte];
        const emoji = emojiMap[s.difficulte];
        const firstLatLng = s.coords[0];

        // correction : pas dâ€™icÃ´ne par dÃ©faut â†’ juste le divIcon
        const marker = L.marker(firstLatLng, { icon: createEmojiIcon(color, emoji) }).addTo(map);

        const popupHTML = `
          <b>${s.nom}</b><br>
          ${s.difficulte} ${emoji}<br>
          Bitume: ${'â­'.repeat(s.bitume)}<br>
          Trafic: ${'ğŸš—'.repeat(s.trafic)}<br>
          <a href="${s.video}" target="_blank">ğŸ¥ Voir la vidÃ©o</a><br>
          <a href="${s.lien}" target="_blank">ğŸ“ Point de dÃ©part (Google Maps)</a>
        `;
        marker.bindPopup(popupHTML);

        const polyline = L.polyline(s.coords, { color: color, weight: 4, opacity: 0.9 });

        marker.on('click', () => {
          if (map.hasLayer(polyline)) map.removeLayer(polyline);
          else map.addLayer(polyline);
        });

        registry.push({ spot: s, marker, polyline });
      });
    }

    renderSpots();

    // Modal
    const modal = document.getElementById('addSpotModal');
    document.getElementById('add-button').addEventListener('click', () => modal.style.display = 'block');
    document.getElementById('modalClose').addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
  </script>
</body>
</html>
