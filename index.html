<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte Freebord - Les Bains</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .emoji-marker { font-size: 24px; line-height: 24px; text-align: center; }
    .leaflet-popup-content { font-size: 14px; }
    #helpButton {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      padding: 5px 10px;
      cursor: pointer;
    }
    #filters {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div id="filters">
    <label><input type="checkbox" id="showBlue" checked> Bleu</label>
    <label><input type="checkbox" id="showRed" checked> Rouge</label>
    <label><input type="checkbox" id="showBlack" checked> Noir</label>
  </div>
  <div id="helpButton">Help</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Emojis
    function getStars(nb) { return '⭐'.repeat(nb); }
    function getCars(nb) { return '🚗'.repeat(nb); }

    // Spot unique
    var spots = [
      {
        nom: "Les Bains",
        lat: 46.514054,
        lng: 6.618280,
        difficulte: "rouge",
        bitume: 4,
        trafic: 3,
        video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        lien: "https://maps.app.goo.gl/bXnBMYr7HbhJfJEc8",
        polyline: [
          [46.51395,6.61827],[46.5139,6.61824],[46.51385,6.61822],[46.51332,6.61796],
          [46.51232,6.61746],[46.512,6.61732],[46.51192,6.61724],[46.51191,6.61723],
          [46.51187,6.61719],[46.51185,6.61716],[46.51183,6.61714]
        ]
      }
    ];

    var map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    var bounds = [];
    spots.forEach(s => bounds.push([s.lat, s.lng]));
    map.fitBounds(bounds);

    var activePolylines = new Map();
    var markers = [];

    function drawMarkers() {
      // Supprime tous les markers existants
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      // Filtrage
      var showBlue = document.getElementById('showBlue').checked;
      var showRed = document.getElementById('showRed').checked;
      var showBlack = document.getElementById('showBlack').checked;

      spots.forEach(spot => {
        if ((spot.difficulte === 'bleu' && !showBlue) ||
            (spot.difficulte === 'rouge' && !showRed) ||
            (spot.difficulte === 'noir' && !showBlack)) return;

        var emoji = spot.difficulte === "bleu" ? "🔵" : spot.difficulte === "rouge" ? "🔴" : "⚫";

        var marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            html: emoji,
            className: "emoji-marker",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          })
        }).addTo(map);

        var popupContent = `
          <b>${spot.nom}</b><br>
          Bitume: ${getStars(spot.bitume)}<br>
          Trafic: ${getCars(spot.trafic)}<br>
          <a href="${spot.lien}" target="_blank">Point de départ</a><br>
          <iframe width="200" height="113" src="${spot.video}" frameborder="0" allowfullscreen></iframe>
        `;
        marker.bindPopup(popupContent);

        marker.on('mouseover', function() { if (!L.Browser.mobile) marker.openPopup(); });

        marker.on('click', function() {
          if (activePolylines.has(spot.nom)) {
            map.removeLayer(activePolylines.get(spot.nom));
            activePolylines.delete(spot.nom);
          } else {
            var color = spot.difficulte === "bleu" ? "#007bff" : spot.difficulte === "rouge" ? "#ff0000" : "#000000";
            var polyline = L.polyline(spot.polyline, {color: color, weight: 4}).addTo(map);
            activePolylines.set(spot.nom, polyline);
          }
        });

        markers.push(marker);
      });
    }

    drawMarkers();

    // Gestion des filtres
    document.getElementById('showBlue').addEventListener('change', drawMarkers);
    document.getElementById('showRed').addEventListener('change', drawMarkers);
    document.getElementById('showBlack').addEventListener('change', drawMarkers);

    // Bouton Help
    document.getElementById('helpButton').addEventListener('click', () => {
      alert("Cliquez sur un emoji pour afficher la polyline du spot.\nUtilisez les filtres pour masquer/afficher certains niveaux de difficulté.");
    });

  </script>
</body>
</html>
