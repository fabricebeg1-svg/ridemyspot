<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte Freebord Spots</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .custom-button-container {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      z-index: 5;
    }
    .custom-button {
      background-color: white;
      border: 1px solid #ccc;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 14px;
    }
    .popup-form {
      display: none;
      position: absolute;
      top: 50px; /* ✅ descendu pour ne pas chevaucher */
      left: 10px;
      background: white;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      z-index: 10;
      width: 280px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.2);
    }
    .popup-form select,
    .popup-form input {
      width: 100%;
      margin-bottom: 10px;
      padding: 5px;
    }
    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
    }
    .star-rating input {
      display: none;
    }
    .star-rating label {
      font-size: 20px;
      color: lightgray;
      cursor: pointer;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: gold;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Boutons -->
  <div class="custom-button-container">
    <button class="custom-button" onclick="toggleFilter()">Filtre</button>
    <button class="custom-button" onclick="toggleAddSpot()">Ajouter un spot</button>
    <button class="custom-button" onclick="openHelp()">Help</button>
  </div>

  <!-- Formulaire Filtre -->
  <div id="filterForm" class="popup-form">
    <h3>Filtrer les spots</h3>
    <select id="filterCountry"><option value="">Pays</option></select>
    <select id="filterRegion"><option value="">Région/Canton</option></select>
    <select id="filterCity"><option value="">Ville</option></select>
    <select id="filterDifficulty">
      <option value="">Difficulté</option>
      <option value="Facile">Facile</option>
      <option value="Moyen">Moyen</option>
      <option value="Difficile">Difficile</option>
    </select>
    <button onclick="applyFilters()">Appliquer</button>
  </div>

  <!-- Formulaire Ajouter un Spot -->
  <div id="addSpotForm" class="popup-form">
    <h3>Ajouter un spot</h3>
    <input type="text" id="addCountry" placeholder="Pays">
    <input type="text" id="addRegion" placeholder="Région / Canton">
    <input type="text" id="addCity" placeholder="Ville">
    <input type="text" id="addGpx" placeholder="Lien Google Maps du tracé">
    <select id="addDifficulty">
      <option value="">Difficulté</option>
      <option value="Facile">Facile</option>
      <option value="Moyen">Moyen</option>
      <option value="Difficile">Difficile</option>
    </select>
    <label>Qualité du bitume :</label>
    <div class="star-rating">
      <input type="radio" id="bitume5" name="bitume" value="5"><label for="bitume5">★</label>
      <input type="radio" id="bitume4" name="bitume" value="4"><label for="bitume4">★</label>
      <input type="radio" id="bitume3" name="bitume" value="3"><label for="bitume3">★</label>
      <input type="radio" id="bitume2" name="bitume" value="2"><label for="bitume2">★</label>
      <input type="radio" id="bitume1" name="bitume" value="1"><label for="bitume1">★</label>
    </div>
    <label>Trafic :</label>
    <select id="addTraffic">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <input type="text" id="addVideo" placeholder="Lien vidéo">
    <button onclick="sendSpot()">Envoyer</button>
  </div>

  <script>
    let map;
    let markers = [];
    let polylines = [];

    const spots = [
      {
        name: "L’ébain",
        country: "Suisse",
        region: "Vaud",
        city: "Lausanne",
        difficulty: "Moyen",
        coordinates: { lat: 46.5191, lng: 6.6336 },
        path: [
          { lat: 46.5191, lng: 6.6336 },
          { lat: 46.5200, lng: 6.6350 },
          { lat: 46.5210, lng: 6.6365 }
        ]
      }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 46.5, lng: 6.6 },
        zoom: 12,
      });

      loadSpots();
      populateFilters();
    }

    function loadSpots() {
      spots.forEach((spot, index) => {
        let color;
        if (spot.difficulty === "Facile") color = "blue";
        else if (spot.difficulty === "Moyen") color = "red";
        else color = "black";

        const marker = new google.maps.Marker({
          position: spot.coordinates,
          map,
          title: spot.name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: color,
            fillOpacity: 1,
            strokeWeight: 1,
            strokeColor: "white",
          }
        });

        // Polyline créée mais invisible par défaut
        const polyline = new google.maps.Polyline({
          path: spot.path,
          geodesic: true,
          strokeColor: color,
          strokeOpacity: 1.0,
          strokeWeight: 2,
          map: null
        });

        marker.addListener("click", () => {
          if (polyline.getMap()) {
            polyline.setMap(null);
          } else {
            polyline.setMap(map);
          }
        });

        markers.push({ marker, spot });
        polylines.push({ polyline, spot });
      });
    }

    function populateFilters() {
      const countrySet = new Set(spots.map(s => s.country));
      const regionSet = new Set(spots.map(s => s.region));
      const citySet = new Set(spots.map(s => s.city));

      const countrySelect = document.getElementById("filterCountry");
      const regionSelect = document.getElementById("filterRegion");
      const citySelect = document.getElementById("filterCity");

      countrySet.forEach(c => {
        countrySelect.innerHTML += `<option value="${c}">${c}</option>`;
      });
      regionSet.forEach(r => {
        regionSelect.innerHTML += `<option value="${r}">${r}</option>`;
      });
      citySet.forEach(c => {
        citySelect.innerHTML += `<option value="${c}">${c}</option>`;
      });
    }

    function applyFilters() {
      const country = document.getElementById("filterCountry").value;
      const region = document.getElementById("filterRegion").value;
      const city = document.getElementById("filterCity").value;
      const difficulty = document.getElementById("filterDifficulty").value;

      markers.forEach((m, i) => {
        const visible =
          (!country || m.spot.country === country) &&
          (!region || m.spot.region === region) &&
          (!city || m.spot.city === city) &&
          (!difficulty || m.spot.difficulty === difficulty);

        m.marker.setMap(visible ? map : null);
        polylines[i].polyline.setMap(visible && polylines[i].polyline.getMap() ? map : null);
      });
    }

    function toggleFilter() {
      const f = document.getElementById("filterForm");
      f.style.display = f.style.display === "block" ? "none" : "block";
    }
    function toggleAddSpot() {
      const f = document.getElementById("addSpotForm");
      f.style.display = f.style.display === "block" ? "none" : "block";
    }
    function openHelp() {
      window.location.href = "mailto:tonmail@example.com?subject=Aide Freebord Map";
    }
    function sendSpot() {
      const mailto = `mailto:tonmail@example.com?subject=Ajout Spot&body=Pays: ${document.getElementById("addCountry").value}%0ARegion/Canton: ${document.getElementById("addRegion").value}%0AVille: ${document.getElementById("addCity").value}%0ADifficulté: ${document.getElementById("addDifficulty").value}%0ALien tracé: ${document.getElementById("addGpx").value}%0ABitume: ${document.querySelector('input[name="bitume"]:checked')?.value || ""}%0ATrafic: ${document.getElementById("addTraffic").value}%0ALien vidéo: ${document.getElementById("addVideo").value}`;
      window.location.href = mailto;
    }
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
</body>
</html>
