<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Carte Freebord</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map { height: 100vh; }
  .marker-bleu { font-size: 24px; color: blue; }
  .marker-rouge { font-size: 24px; color: red; }
  .marker-noir { font-size: 24px; color: black; }
  #filterPanel, #addSpotPanel { 
    background: white; 
    padding: 10px; 
    position: absolute; 
    top: 50px; /* d√©calage pour ne pas chevaucher les boutons */
    right: 10px; 
    z-index: 1000; 
    border: 1px solid #ccc; 
    border-radius: 5px; 
    display: none;
    max-width: 250px;
  }
  .buttonPanel { position: absolute; top: 10px; right: 10px; z-index: 1001; }
  select, input { width: 100%; margin-bottom: 5px; }
  button { margin-top: 5px; width: 100%; }
</style>
</head>
<body>

<div id="map"></div>

<div class="buttonPanel">
  <button id="filterBtn">Filtrer</button>
  <button id="addSpotBtn">Ajouter un spot</button>
  <button id="helpBtn">Help</button>
</div>

<div id="filterPanel">
  <label>Pays: <select id="filterCountry"><option value="">Tous</option></select></label>
  <label>Canton/R√©gion: <select id="filterCanton"><option value="">Tous</option></select></label>
  <label>Ville: <select id="filterCity"><option value="">Toutes</option></select></label>
  <label>Difficult√©: 
    <select id="filterDifficulty">
      <option value="">Toutes</option>
      <option value="bleu">Facile</option>
      <option value="rouge">Moyen</option>
      <option value="noir">Difficile</option>
    </select>
  </label>
  <button id="applyFilterBtn">Appliquer</button>
</div>

<div id="addSpotPanel">
  <label>Nom: <input type="text" id="spotName"></label>
  <label>Lien Google Maps du trac√©: <input type="text" id="spotCoords" placeholder="https://www.google.com/maps/..."></label>
  <label>Ville: <input type="text" id="spotCity"></label>
  <label>Canton/R√©gion: <input type="text" id="spotCanton"></label>
  <label>Pays: <input type="text" id="spotCountry"></label>
  <label>Difficult√©: 
    <select id="spotDifficulty">
      <option value="bleu">Facile</option>
      <option value="rouge">Moyen</option>
      <option value="noir">Difficile</option>
    </select>
  </label>
  <label>Bitume (1-5): 
    <select id="spotBitume">
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>
  </label>
  <label>Trafic (1-5): 
    <select id="spotTraffic">
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>
  </label>
  <label>Vid√©o (URL): <input type="text" id="spotVideo"></label>
  <button id="spotSendBtn">Envoyer</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Initialisation de la carte ---
const map = L.map('map').setView([46.5191, 6.5668], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// --- Spots ---
const spots = [
  {
    nom: "Les Bains",
    difficulte: "rouge",
    bitume: 4,
    trafic: 3,
    video: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    lien: "https://maps.app.goo.gl/bXnBMYr7HbhJfJEc8",
    ville: "Lausanne",
    canton: "VD",
    pays: "Suisse",
    coordinates: [
      [46.51395,6.61827],[46.5139,6.61824],[46.51385,6.61822],[46.51332,6.61796],[46.51232,6.61746],
      [46.512,6.61732],[46.51192,6.61724],[46.51191,6.61723],[46.51187,6.61719],[46.51185,6.61716],[46.51183,6.61714]
    ]
  }
];

const polylines = {};
const markers = {};

// --- Cr√©ation des markers ---
function addSpotMarker(spot) {
  const emoji = spot.difficulte === "bleu" ? "üîµ" : spot.difficulte === "rouge" ? "üî¥" : "‚ö´";
  const marker = L.marker(spot.coordinates[0], {
    icon: L.divIcon({
      className: `marker-${spot.difficulte}`,
      html: emoji,
      iconSize: [24,24]
    })
  }).addTo(map);
  marker.bindPopup(`
    <b>${spot.nom}</b><br>
    Bitume: ${spot.bitume}/5<br>
    Trafic: ${spot.trafic}/5<br>
    <a href="${spot.video}" target="_blank">Vid√©o</a><br>
    <a href="${spot.lien}" target="_blank">D√©part Google Maps</a>
  `);
  marker.on('click', () => {
    if (polylines[spot.nom]) {
      map.removeLayer(polylines[spot.nom]);
      delete polylines[spot.nom];
    } else {
      polylines[spot.nom] = L.polyline(spot.coordinates, {color: spot.difficulte}).addTo(map);
    }
  });
  markers[spot.nom] = marker;
}

// --- Initialisation des markers ---
spots.forEach(addSpotMarker);

// --- Boutons ---
const filterPanel = document.getElementById('filterPanel');
const addSpotPanel = document.getElementById('addSpotPanel');

document.getElementById('filterBtn').addEventListener('click', () => {
  filterPanel.style.display = filterPanel.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('addSpotBtn').addEventListener('click', () => {
  addSpotPanel.style.display = addSpotPanel.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('helpBtn').addEventListener('click', () => {
  window.location.href = 'mailto:tonmail@example.com?subject=Aide Freebord';
});

// --- G√©n√©ration dynamique des options de filtre ---
function populateFilters() {
  const countrySet = new Set();
  const cantonSet = new Set();
  const citySet = new Set();
  spots.forEach(s => {
    countrySet.add(s.pays);
    cantonSet.add(s.canton);
    citySet.add(s.ville);
  });
  const fc = document.getElementById('filterCountry');
  const fct = document.getElementById('filterCanton');
  const fci = document.getElementById('filterCity');
  
  countrySet.forEach(c => { const o = document.createElement('option'); o.value=c;o.text=c; fc.add(o); });
  cantonSet.forEach(c => { const o = document.createElement('option'); o.value=c;o.text=c; fct.add(o); });
  citySet.forEach(c => { const o = document.createElement('option'); o.value=c;o.text=c; fci.add(o); });
}
populateFilters();

// --- Application du filtre ---
document.getElementById('applyFilterBtn').addEventListener('click', () => {
  const country = document.getElementById('filterCountry').value;
  const canton = document.getElementById('filterCanton').value;
  const city = document.getElementById('filterCity').value;
  const difficulty = document.getElementById('filterDifficulty').value;
  
  spots.forEach(s => {
    const marker = markers[s.nom];
    const show = 
      (country === "" || s.pays === country) &&
      (canton === "" || s.canton === canton) &&
      (city === "" || s.ville === city) &&
      (difficulty === "" || s.difficulte === difficulty);
    
    if(show) {
      marker.addTo(map);
    } else {
      map.removeLayer(marker);
      if(polylines[s.nom]) {
        map.removeLayer(polylines[s.nom]);
        delete polylines[s.nom];
      }
    }
  });
});

// --- Envoyer un spot ---
document.getElementById('spotSendBtn').addEventListener('click', () => {
  const nom = document.getElementById('spotName').value;
  const coords = document.getElementById('spotCoords').value;
  const ville = document.getElementById('spotCity').value;
  const canton = document.getElementById('spotCanton').value;
  const pays = document.getElementById('spotCountry').value;
  const difficulte = document.getElementById('spotDifficulty').value;
  const bitume = document.getElementById('spotBitume').value;
  const trafic = document.getElementById('spotTraffic').value;
  const video = document.getElementById('spotVideo').value;
  
  const mailBody = `Nom: ${nom}\nLien Google Maps: ${coords}\nVille: ${ville}\nCanton/R√©gion: ${canton}\nPays: ${pays}\nDifficult√©: ${difficulte}\nBitume: ${bitume}\nTrafic: ${trafic}\nVid√©o: ${video}`;
  window.location.href = `mailto:tonmail@example.com?subject=Nouveau Spot Freebord&body=${encodeURIComponent(mailBody)}`;
});
</script>

</body>
</html>
